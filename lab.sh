#!/bin/bash

# Check if Docker is already installed
if ! [ -x "$(command -v docker)" ]; then
    echo "Docker is not installed. Installing Docker..."
    # Update package index and install Docker
    sudo apt update
    sudo apt install -y docker.io
    
    # Add current user to the "docker" group
    sudo usermod -aG docker $USER
    
    echo "Docker has been installed successfully."
else
    echo "Docker is already installed."
fi

# Check if unzip package is installed
if ! [ -x "$(command -v unzip)" ]; then
    echo "Unzip package is not installed. Installing unzip..."
    # Install unzip package
    sudo apt install -y unzip
    echo "Unzip has been installed successfully."
else
    echo "Unzip package is already installed."
fi

# Download the zip file
echo "Downloading the zip file..."
wget -O file.zip "https://down.chinaz.com/api/index/download?id=51308&type=code"
echo "Download completed. The zip file has been saved as file.zip."

# Unzip the file
echo "Unzipping the file..."
unzip file.zip
echo "Unzip completed."

# Build Docker image
echo "Building Docker image..."
docker build -t test .
echo "Docker image has been built successfully."

# Run Docker container
echo "Running Docker container..."
docker run -d -p 80:80 test
echo "Docker container is running."

# Find container ID for the "test" container
container_id=$(docker ps -a --filter "ancestor=test" --format "{{.ID}}")

if [ -z "$container_id" ]; then
    echo "Failed to find the container ID for the 'test' container."
else
    echo "Container ID for the 'test' container: $container_id"
    echo "Executing interactive bash in the container..."
    docker exec -it $container_id /bin/bash -c "mysql -u root -p -e \"GRANT ALL PRIVILEGES ON *.* TO 'root'@'localhost' IDENTIFIED BY 'adarsh' WITH GRANT OPTION; FLUSH PRIVILEGES;\""
fi
